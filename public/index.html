<head>
    <style> body { margin: 0; } </style>
  
    <script src="//unpkg.com/three"></script>
    <script src="//unpkg.com/three-spritetext"></script>
    <script src="//unpkg.com/3d-force-graph"></script>
    <script src="https://unpkg.com/neo4j-driver"></script>
    <!--<script src="../../dist/3d-force-graph.js"></script>-->
  </head>
  
  <body>
    <div id="3d-graph"></div>
  
    <script>
      const elem = document.getElementById('3d-graph');
      const driver = neo4j.driver("neo4j+s://demo.neo4jlabs.com", neo4j.auth.basic("inspired", "inspired"));
      const session = driver.session({database:"inspired"});
      const start = new Date()
      const query = `
      MATCH (m:User)-[:POSTED]->(t:Tweet)-[:MENTIONED]->(n:User),(t)-[:TAGGED]->(:Tag {name:"inspiredby"})
      RETURN { id: id(n), label:head(labels(n)), community:n.louvain, caption:n.screen_name, size:(size((n)<--())+1)/10.0 } as source, 
        { id: id(m), label:head(labels(m)), community:n.louvain, caption:m.screen_name, size:(size((m)<--())+1)/10.0 } as target, 
        {weight:1, type:'INSPIRED', community:case when n.community < m.community then n.community else m.community end} as rel 
      LIMIT $limit
      `;
      session
        .run(query, {limit: neo4j.int(5000)})
        .then(function (result) {
          const nodes = {}
          const links = result.records.map(r => { 
             var source = r.get('source');source.id = source.id.toNumber();
             nodes[source.id] = source;
             var target = r.get('target');target.id = target.id.toNumber();
             nodes[target.id] = target;
             var rel = r.get('rel'); if (rel.weight) { rel.weight = rel.weight.toNumber(); }
             return Object.assign({source:source.id,target:target.id}, rel);
          });
          session.close();
          console.log(links.length+" links loaded in "+(new Date()-start)+" ms.")
          const gData = { nodes: Object.values(nodes), links: links}
          // https://github.com/vasturiano/3d-force-graph#link-styling
          const Graph = ForceGraph3D()(elem)
                        .graphData(gData)
                        // .nodeColor("#018bff")
                        .nodeAutoColorBy('label') // community
                        .nodeVal('size')
                        .linkColor('white')
                        .linkOpacity(0.7)
                        // .linkAutoColorBy('type') // community
                        .linkWidth(1)
                        // .linkDirectionalParticles(20) // ('weight')
                        // .linkDirectionalParticleSpeed(0.1) // 'weight'
                        // .linkDirectionalParticleColor
                        .nodeLabel(node => node.caption)
                        .nodeThreeObject(node => {
                          console.log(node.caption);
                          const sprite = new SpriteText(node.caption);
                          sprite.material.depthWrite = false; // make sprite background transparent
                          sprite.color = node.color;
                          sprite.textHeight = 6;
                          return sprite;
                        })
                        .onNodeClick(node => window.open("https://twitter.com/"+node.caption))
                        .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null);
        })
        .catch(function (error) {
          console.log(error);
        });
    </script>
  </body>